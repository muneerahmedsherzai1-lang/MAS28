name: Windows 11 General Tasks with RDP (Fixed)

on:
  push:
  workflow_dispatch:

jobs:
  general-tasks:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Display System Information
        shell: pwsh
        run: |
          Write-Host "===== SYSTEM INFO ====="
          systeminfo | Select-String "OS Name","OS Version","System Type"
          Write-Host "======================="

      - name: Enable RDP with Strong Password (Auto Fix)
        shell: pwsh
        run: |
          Write-Host "Enabling Remote Desktop..."

          # Generate strong password (Windows policy compliant)
          $Password = -join (
            (48..57 + 65..90 + 97..122 + 33..38) |
            Get-Random -Count 16 |
            ForEach-Object { [char]$_ }
          )

          # Set password for runneradmin
          net user runneradmin "$Password"

          # Enable RDP
          Set-ItemProperty `
            -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name "fDenyTSConnections" -Value 0

          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Write-Host "================================="
          Write-Host "RDP LOGIN DETAILS"
          Write-Host "Username : runneradmin"
          Write-Host "Password : $Password"
          Write-Host "================================="

      - name: Download and Configure Ngrok
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          Invoke-WebRequest `
            https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip `
            -OutFile ngrok.zip

          Expand-Archive ngrok.zip -Force
          .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN

      - name: Start Ngrok RDP Tunnel
        shell: pwsh
        run: |
          Start-Process -NoNewWindow `
            -FilePath .\ngrok\ngrok.exe `
            -ArgumentList "tcp 3389"

          Start-Sleep -Seconds 10
          Write-Host "NGROK RDP ADDRESS:"
          Invoke-RestMethod http://127.0.0.1:4040/api/tunnels

      - name: Install Development Tools
        shell: pwsh
        run: |
          choco install nodejs git 7zip -y
          node -v
          git --version

      - name: Keep RDP Session Alive (6 Hours)
        shell: pwsh
        run: |
          Write-Host "RDP is active. Do NOT stop the workflow."
          Start-Sleep -Seconds 21600
