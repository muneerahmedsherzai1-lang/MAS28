name: Windows 11 Pro RDP (Self-Hosted)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: self-hosted

    steps:
      - name: Enable RDP & Optimize
        shell: pwsh
        run: |
          Write-Host "Enabling RDP..."

          Set-ItemProperty `
            -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name "fDenyTSConnections" -Value 0

          Set-ItemProperty `
            -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "UserAuthentication" -Value 1

          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "rdpuser"
          $pass = -join ((48..57 + 65..90 + 97..122) | Get-Random -Count 16 | ForEach-Object {[char]$_})

          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            $secure = ConvertTo-SecureString $pass -AsPlainText -Force
            New-LocalUser $user -Password $secure -AccountNeverExpires
            Add-LocalGroupMember Administrators $user
            Add-LocalGroupMember "Remote Desktop Users" $user
          }

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Ensure Tailscale Running
        shell: pwsh
        run: |
          if (-not (Get-Service Tailscale -ErrorAction SilentlyContinue)) {
            winget install tailscale --silent
          }

          Start-Service Tailscale -ErrorAction SilentlyContinue

          tailscale up --accept-dns --accept-routes

          $ip = tailscale ip -4
          echo "TS_IP=$ip" >> $env:GITHUB_ENV

      - name: System Info (RAM / Disk / GPU)
        shell: pwsh
        run: |
          systeminfo | findstr /B /C:"OS Name" /C:"Total Physical Memory"
          Get-PSDrive C
          Get-CimInstance Win32_VideoController | Select Name

      - name: RDP Access Info
        shell: pwsh
        run: |
          Write-Host "=============================="
          Write-Host " OS        : Windows 11 Pro"
          Write-Host " Address   : $env:TS_IP"
          Write-Host " Username  : $env:RDP_USER"
          Write-Host " Password  : $env:RDP_PASS"
          Write-Host "=============================="

      - name: Keep Runner Alive
        shell: pwsh
        run: |
          while ($true) {
            Start-Sleep 300
          }
